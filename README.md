# Unix-Shell

source：https://brennan.io/2015/01/16/write-a-shell-in-c/  
虽然开发大型软件项目并不容易，但很多时候这种软件的基本思想都很简单。

Shell的基本生命周期：main()  
1，初始化：加载并执行配置文件；  
2，解释执行：从输入stdin（交互式或文件）读取命令，并执行；  
3，终止：执行关闭shutdown命令，释放内存，终止。  
我们的Shell很简单，没有配置文件，没有关闭命令。直接调用循环函数然后终止。

Shell的基本循环：lsh_loop()  
处理命令  
1，读取：从标准输入读取一个命令；  
2，分析：将命令字符串分解为程序名和参数；  
3，执行：运行分析后的命令。  

读取命令：lsh_read_line()  
问题：无法提前知道用户会输入多少文本到shell  
方法：先分配一定大小的空间，若标准输入超出空间大小，则再分配更多的空间。也可用getline()函数实现该功能。  

分析命令：lsh_split_line()  
简化：命令行参数中不允许使用引号和反斜杠转义，而是使用空白字符作为参数间的分割。这样的话，命令 echo "this message" 就不是使用单个参数 this message 调用 echo，而是有两个参数： "this 和 message"。  

执行命令：lsh_execute()  
启动进程：lsh_lauch()  
Shell的主要功能就是启动进程。Unix有两种启动进程的方法：  
1，成为Init进程。  
Unix计算机启动时，会加载其内核，完成加载和初始化后，内核只会启动一个进程，就是Init进程。这个进程会在计算机开启时一直运行，并管理载入其他进程。但是大部分进程都不是Init进程。  
2，使用fork()和exec()系统调用。  
当调用该函数时，操作系统会将当前进程复制一份，并让两者同时运行。  
原有的进程叫做“父进程”，而新的进程叫做“子进程”。  
fork() 会在子进程中返回 0，在父进程中返回子进程的进程 ID 号（PID）。  
这意味着新进程启动的唯一方法是复制一个已有的进程。  
			
但我们不想使用相同进程的拷贝，而是一个新的进程，这时需要使用exec()系统调用，它会将当前运行的程序替换为一个全新的程序。  
先使用fork()拷贝一个进程，再使用exec()将进程替换为新的程序进程。

Shell内置函数：lsh_cd()，lsh_help()，lsh_exit()  
虽然 shell 执行的命令大部分是程序，但有一些不是。一些命令是 shell 内置的。  
比如如果你想改变当前目录，你需要使用函数 chdir()。问题是，当前目录是进程的一个属性。那么，如果你写了一个叫 cd 的程序来改变当前目录，它只会改变自己当前的目录，然后终止。它的父进程的当前目录不会改变。所以应当是 shell 进程自己执行 chdir()，才能更新自己的当前目录。然后，当它启动子进程时，子进程也会继承这个新的目录。 

组合内置命令与进程：lsh_execute()  
lsh_execute()函数要么启动一个内置命令，要么启动一个进程。  

全部组合在一起：  
	需要使用的头文件：  
	#include <sys/wait.h>  
		waitpid() 及其相关的宏  
	#include <unistd.h>  
		chdir()  
		fork()  
		exec()  
		pid_t  
	#include <stdlib.h>  
		malloc()  
		realloc()  
		free()  
		exit()  
		execvp()  
		EXIT_SUCCESS, EXIT_FAILURE  
	#include <stdio.h>  
		fprintf()  
		printf()  
		stderr  
		getchar()  
		perror()  
	#include <string.h>  
		strcmp()  
		strtok()  
	将所有代码片段复制到一个文件中（main.c），运行 gcc -o main main.c 进行编译，然后 ./main 来运行即可。  

如果你知道你要找什么系统调用，只是想知道如何使用它，那么手册页（man pages）是你最好的朋友。如果你不知道 C 标准库和 Unix 为你提供了什么样的接口，我推荐你阅读 POSIX 规范，特别是第 13 章，“头文件”。你可以找到每个头文件，以及其中需要定义哪些内容。  

显然，这个 shell 的功能不够丰富。一些明显的遗漏有：  
	只用了空白符分割参数，没有考虑到引号和反斜杠转义。  
	没有管道和重定向。  
	内置命令太少。  
	没有通配符。  

